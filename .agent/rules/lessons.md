# Lessons Learned

> Patterns, mistakes, and insights accumulated during development.
> Updated automatically after corrections — reviewed at session start.

## Hono: Separate app from server startup
- Importing `index.ts` that calls `serve()` during Vitest starts a real HTTP server → `EADDRINUSE`.
- **Fix**: Routes in `app.ts` (pure). `serve()` in `index.ts` (entry only). Tests import `app.ts`.

## Vitest: Exclude dist/ from test discovery
- After `tsc` build, Vitest picks up compiled `.js` tests in `dist/` alongside `.ts` source tests.
- **Fix**: `exclude: ['dist/**', 'node_modules/**']` in `vitest.config.ts`.

## TypeScript: Use `bundler` moduleResolution for SvelteKit/Vite
- `NodeNext` forces `.js` extensions on relative imports, breaking SvelteKit/Vite.
- **Fix**: `"moduleResolution": "bundler"` in `tsconfig.base.json`.

## TypeScript: TS4023 with `better-sqlite3` namespaced types
- Exporting variables whose type is `BetterSqlite3.Database` (namespace type from `@types/better-sqlite3`) causes TS4023 "cannot be named" errors in declaration files.
- **Fix**: Import `type BetterSqlite3 from 'better-sqlite3'` in the exporting file and add explicit type annotations — TS needs the type import in scope to name it in `.d.ts`.

## drizzle-kit: Does not auto-create parent directories
- `drizzle-kit migrate` uses its own `better-sqlite3` instance and does NOT auto-create parent dirs for the DB file.
- **Fix**: Prefix the npm script with `mkdir -p data &&` to ensure the directory exists.

## npm: Always verify package versions against registry
- Web search results for "latest version" may be stale or wrong (e.g. `@eslint/js@^10.0.2` doesn't exist — latest is `10.0.1`).
- **Fix**: Before installing, run `npm view <pkg> version` to confirm actual latest. Same for `prettier-plugin-svelte` (v3, not v4).

## CI: Gitignored generated files must be compiled before typecheck
- Paraglide output (`$lib/paraglide/`) is gitignored and generated by the Vite plugin during `vite dev`/`vite build`. In fresh CI checkouts these files don't exist, so `svelte-check` fails on missing module imports.
- **Fix**: Run `paraglide-js compile` before `svelte-check` in the `typecheck` script. Always simulate CI conditions locally (delete generated dirs) when verifying CI scripts.

## Docker: npm workspaces hoist deps to root node_modules
- `npm ci` with workspaces installs everything into the root `node_modules/`. Per-package `node_modules/` directories do NOT exist.
- **Fix**: In Dockerfiles, only `COPY` the root `node_modules/`, not per-package ones.

## Docker: npm lifecycle scripts (prepare/husky) fail in containers
- `npm ci` triggers `prepare` which runs `husky` — a devDependency not available in `--omit=dev` installs, or even with all deps when husky isn't installed globally.
- **Fix**: Use `npm ci --ignore-scripts` + explicit `npm rebuild <native-addon>` for addons like `better-sqlite3`.

## Docker: Global npm install not resolvable by node --import
- `npm install -g tsx` installs outside the project's module resolution scope. `node --import tsx` fails with `ERR_MODULE_NOT_FOUND`.
- **Fix**: Install tsx as a local dependency (`npm install tsx`) so it's in `node_modules/` and resolvable.

## Drizzle: Avoid `get()!` non-null assertions
- `db.select().from(table).where(...).get()!` triggers `@typescript-eslint/no-non-null-assertion` (27 errors in Phase 2).
- **Fix**: Create shared helpers: `mustGet(result)` for post-INSERT reads and `countRows(db, table, where?)` for aggregates. Import from `db/db-helpers.ts`.

## Hono: `onError` only receives Error instances
- Hono's `onError` handler receives `Error | HTTPException`. Throwing non-Error values (strings, numbers) causes Hono to re-throw them rather than passing to `onError`.
- **Fix**: Only test error handler with `Error` subclasses (e.g., `TypeError`, `Error`). Non-Error throws are an anti-pattern anyway.

## SvelteKit: `page.params.id` is `string | undefined`
- Route params from `$app/state`'s `page.params` are `string | undefined`, not `string`. Passing directly to functions expecting `string` triggers TS errors.
- **Fix**: Always coalesce route params: `page.params.id ?? ''`, then guard downstream calls.

## JavaScript: `-0` from multiplication
- `0 * -120` produces `-0`, which fails `Object.is(-0, 0)` and thus Jest/Vitest `.toBe(0)`.
- **Fix**: Use `|| 0` coercion when the result should never be negative zero.

## Svelte 5: TreeCanvas interactive div pattern
- `<div>` with `role="application"` + mouse event handlers is valid a11y (interactive canvas), but svelte-check still warns about non-interactive element interactions.
- **Fix**: Add `<!-- svelte-ignore a11y_no_noninteractive_element_interactions -->`. The `role="application"` makes the div semantically interactive.

## Security: Always sanitize user-provided filenames in storage paths
- Using `path.join(base, id, filename)` with user-uploaded filenames allows path traversal (e.g., `../../etc/passwd`).
- **Fix**: Pass all filenames through `path.basename()` to strip directory components before constructing paths. Add a `sanitizeFilename()` helper.

## Node.js: Don't use async imports in synchronous factory functions
- `createLocalStorage()` used `import('node:fs').then(fs => fs.mkdirSync(...))` which is async but the function returned synchronously — the mkdir could complete after the adapter is already used.
- **Fix**: Use synchronous `mkdirSync()` for startup-time operations. Only use dynamic `import()` when async context is available.

## TypeScript: Always type-annotate API request bodies
- Building POST/PATCH bodies as untyped object literals `{}` silently drops optional fields — the compiler can't warn about missing properties.
- **Fix**: Import the input DTO type (e.g., `CreatePersonInput`) and annotate the body: `const body: CreatePersonInput = { ... }`. List all fields explicitly, even when `undefined`, so future additions are visible at the call site.

## Client: Always transform server person shapes before rendering
- Server returns `PersonWithDetailsRow` (raw `names[]`, `events[]` arrays). UI components expect `PersonWithDetails` (computed `preferredName`, `birthEvent`, `deathEvent`). Passing raw data causes `TypeError: Cannot read properties of undefined (reading 'given')` and crashes the entire person page.
- **Fix**: Always pipe server person responses through `toPersonWithDetails()` before passing to Svelte components. Never assume server shape matches client shape.

## Hono: `c.json()` with status 204 crashes Node
- `apiSuccess(c, null, 204)` calls `c.json({ ok: true, data: null }, 204)` — Node's `Response` constructor rejects status 204 with a body (`TypeError: Invalid response status code 204`).
- **Fix**: Use `c.body(null, 204)` for no-content responses instead of `c.json()`.

## Testing: Always verify actual route paths and response shapes before writing route tests
- Route factories expose paths relative to where they're mounted. `createTreeRoutes` uses `/full` and `/:id` (not `/pedigree/:id`). `createMediaLinkRoutes` uses `/entity/:type/:id` (not `/?entityType=x`). List endpoints return `{ entities: [...], total }` not flat arrays.
- **Fix**: Read the actual route file before writing tests. Check `router.get/post/...` patterns and the service return types.

## Core: Use PARENT_CHILD_TYPES enum values in tests, not generic strings
- `family-graph-layout.ts` checks `PARENT_CHILD_SET.has(edge.type)` — the set contains `'biological_parent'`, `'adoptive_parent'`, etc. Using `'parent-child'` as the edge type in tests causes edges to be treated as partner relationships.
- **Fix**: Always use actual enum values from `@ahnenbaum/core` (e.g., `'biological_parent'`, `'marriage'`) in test fixtures.

