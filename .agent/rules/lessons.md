# Lessons Learned

> Patterns, mistakes, and insights accumulated during development.
> Updated automatically after corrections — reviewed at session start.

## Hono: Separate app from server startup
- Importing `index.ts` that calls `serve()` during Vitest starts a real HTTP server → `EADDRINUSE`.
- **Fix**: Routes in `app.ts` (pure). `serve()` in `index.ts` (entry only). Tests import `app.ts`.

## Vitest: Exclude dist/ from test discovery
- After `tsc` build, Vitest picks up compiled `.js` tests in `dist/` alongside `.ts` source tests.
- **Fix**: `exclude: ['dist/**', 'node_modules/**']` in `vitest.config.ts`.

## TypeScript: Use `bundler` moduleResolution for SvelteKit/Vite
- `NodeNext` forces `.js` extensions on relative imports, breaking SvelteKit/Vite.
- **Fix**: `"moduleResolution": "bundler"` in `tsconfig.base.json`.

## TypeScript: TS4023 with `better-sqlite3` namespaced types
- Exporting variables whose type is `BetterSqlite3.Database` (namespace type from `@types/better-sqlite3`) causes TS4023 "cannot be named" errors in declaration files.
- **Fix**: Import `type BetterSqlite3 from 'better-sqlite3'` in the exporting file and add explicit type annotations — TS needs the type import in scope to name it in `.d.ts`.

## drizzle-kit: Does not auto-create parent directories
- `drizzle-kit migrate` uses its own `better-sqlite3` instance and does NOT auto-create parent dirs for the DB file.
- **Fix**: Prefix the npm script with `mkdir -p data &&` to ensure the directory exists.

## npm: Always verify package versions against registry
- Web search results for "latest version" may be stale or wrong (e.g. `@eslint/js@^10.0.2` doesn't exist — latest is `10.0.1`).
- **Fix**: Before installing, run `npm view <pkg> version` to confirm actual latest. Same for `prettier-plugin-svelte` (v3, not v4).

## CI: Gitignored generated files must be compiled before typecheck
- Paraglide output (`$lib/paraglide/`) is gitignored and generated by the Vite plugin during `vite dev`/`vite build`. In fresh CI checkouts these files don't exist, so `svelte-check` fails on missing module imports.
- **Fix**: Run `paraglide-js compile` before `svelte-check` in the `typecheck` script. Always simulate CI conditions locally (delete generated dirs) when verifying CI scripts.

## Docker: npm workspaces hoist deps to root node_modules
- `npm ci` with workspaces installs everything into the root `node_modules/`. Per-package `node_modules/` directories do NOT exist.
- **Fix**: In Dockerfiles, only `COPY` the root `node_modules/`, not per-package ones.

## Docker: npm lifecycle scripts (prepare/husky) fail in containers
- `npm ci` triggers `prepare` which runs `husky` — a devDependency not available in `--omit=dev` installs, or even with all deps when husky isn't installed globally.
- **Fix**: Use `npm ci --ignore-scripts` + explicit `npm rebuild <native-addon>` for addons like `better-sqlite3`.

## Docker: Global npm install not resolvable by node --import
- `npm install -g tsx` installs outside the project's module resolution scope. `node --import tsx` fails with `ERR_MODULE_NOT_FOUND`.
- **Fix**: Install tsx as a local dependency (`npm install tsx`) so it's in `node_modules/` and resolvable.

## Drizzle: Avoid `get()!` non-null assertions
- `db.select().from(table).where(...).get()!` triggers `@typescript-eslint/no-non-null-assertion` (27 errors in Phase 2).
- **Fix**: Create shared helpers: `mustGet(result)` for post-INSERT reads and `countRows(db, table, where?)` for aggregates. Import from `db/db-helpers.ts`.

## Hono: `onError` only receives Error instances
- Hono's `onError` handler receives `Error | HTTPException`. Throwing non-Error values (strings, numbers) causes Hono to re-throw them rather than passing to `onError`.
- **Fix**: Only test error handler with `Error` subclasses (e.g., `TypeError`, `Error`). Non-Error throws are an anti-pattern anyway.

## SvelteKit: `page.params.id` is `string | undefined`
- Route params from `$app/state`'s `page.params` are `string | undefined`, not `string`. Passing directly to functions expecting `string` triggers TS errors.
- **Fix**: Always coalesce route params: `page.params.id ?? ''`, then guard downstream calls.

## JavaScript: `-0` from multiplication
- `0 * -120` produces `-0`, which fails `Object.is(-0, 0)` and thus Jest/Vitest `.toBe(0)`.
- **Fix**: Use `|| 0` coercion when the result should never be negative zero.

## Svelte 5: TreeCanvas interactive div pattern
- `<div>` with `role="application"` + mouse event handlers is valid a11y (interactive canvas), but svelte-check still warns about non-interactive element interactions.
- **Fix**: Add `<!-- svelte-ignore a11y_no_noninteractive_element_interactions -->`. The `role="application"` makes the div semantically interactive.

## Security: Always sanitize user-provided filenames in storage paths
- Using `path.join(base, id, filename)` with user-uploaded filenames allows path traversal (e.g., `../../etc/passwd`).
- **Fix**: Pass all filenames through `path.basename()` to strip directory components before constructing paths. Add a `sanitizeFilename()` helper.

## Node.js: Don't use async imports in synchronous factory functions
- `createLocalStorage()` used `import('node:fs').then(fs => fs.mkdirSync(...))` which is async but the function returned synchronously — the mkdir could complete after the adapter is already used.
- **Fix**: Use synchronous `mkdirSync()` for startup-time operations. Only use dynamic `import()` when async context is available.
